<!--
	Java Parallel Processing Framework.
	Copyright (C) 2005-2006 Laurent Cohen.
	lcohen@osp-chicago.com

	This library is free software; you can redistribute it and/or modify it
	under the terms of the GNU Lesser General Public License as published by the
	Free Software Foundation; either version 2.1 of the License, or (at your
	option) any later version.

	This library is distributed in the hope that it will be useful, but WITHOUT
	ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
	FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License
	for more details.

	You should have received a copy of the GNU Lesser General Public License
	along with this library; if not, write to the Free Software Foundation,
	Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
-->

<project name='jppf' default="build" basedir="..">

	<!-- ========================================================================= -->
	<!--                          Property definitions                             -->
	<!-- ========================================================================= -->

  <property name="build.properties.file" value="${basedir}/bin/build.properties"/>
  <property file="${build.properties.file}"/>
	<property name="build.number.file" value="${basedir}/bin/build.number"/>
	<property name="bin" value="${basedir}/bin"/>	
	<property name="data" value="${basedir}/data"/>	
	<property name="config" value="${basedir}/config"/>	
	<property name="build" value="${basedir}/build"/>	
	<property name="deploy" value="${build}/deploy"/>	
	<property name="deploy.lib" value="${deploy}/lib"/>
	<property name="deploy.build" value="${deploy}/build"/>
	<property name="deploy.config" value="${deploy}/config"/>	
	<property name="classes" value="${build}/classes"/>
	<property name="bootstrap.classes" value="${build}/bootstrap"/>
	<property name="bootstrap.src" value="${basedir}/bootstrap"/>
	<property name="src" value="${basedir}/src"/>
	<property name="lib" value="${basedir}/lib"/>
	<property name="docs" value="${basedir}/docs"/>
	<property name="home" value="${docs}/home"/>
	<property name="examples" value="${basedir}/examples"/>
	<property name="javadoc" value="${docs}/api"/>
	<property name="app.jar.file" value="${ant.project.name}.jar"/>
	<property name="license.file" value="LICENSE.txt"/>
	<property name="runtime" value="${deploy}/runtime"/>
	<property name="runtime.driver" value="${deploy}/runtime/driver"/>
	<property name="runtime.node" value="${deploy}/runtime/node"/>

	<!-- ========================================================================= -->
	<!--                           Classpath definitions                           -->
	<!-- ========================================================================= -->

	<path id="project.classpath">
		<pathelement location="${classes}"/>
		<pathelement location="${bootstrap.classes}"/>
		<fileset dir="${lib}">
			<include name="**/*.jar"/>
		</fileset>
	</path>

  <path id="javadoc.classpath">
		<pathelement location="${bin}"/>
    <path refid="project.classpath"/>	
  </path>

  <path id="run.classpath">
		<pathelement location="${config}"/>
    <path refid="project.classpath"/>	
  </path>

	<!-- ========================================================================= -->
	<!--                                    Clean                                  -->
	<!-- ========================================================================= -->

  <target name="clean" description="">
    <delete dir="${build}" quiet="true"/>
  </target>               

  <target name="clean.deploy" description="clean the deploy folder">
    <delete dir="${deploy}" quiet="true"/>
	  <delete dir="${runtime}" quiet="true"/>
  </target>               

	<!-- ========================================================================= -->
	<!--                                    Init                                   -->
	<!-- ========================================================================= -->

	<target name="init" description="Initialize ressources">
 		<mkdir dir="${bootstrap.classes}"/>
 		<mkdir dir="${classes}"/>
	</target>

	<target name="init.deploy" description="Initialize ressources">
 		<mkdir dir="${deploy}"/>
 		<mkdir dir="${deploy}/src"/>
 		<mkdir dir="${deploy}/bootstrap"/>
 		<mkdir dir="${deploy.build}/classes"/>
 		<mkdir dir="${deploy.build}/bootstrap"/>
 		<mkdir dir="${deploy}/docs"/>
 		<mkdir dir="${deploy}/examples"/>
 		<mkdir dir="${deploy.config}"/>
		<mkdir dir="${deploy.lib}"/>
		<mkdir dir="${deploy.build}"/>
 		<mkdir dir="${runtime.driver}"/>
 		<mkdir dir="${runtime.node}"/>
	</target>

	<!-- ========================================================================= -->
	<!--                           Build the application                           -->
	<!-- ========================================================================= -->

  <target name="build" depends="init, compile, jar"/>
	<target name="rebuild" depends="clean, init, compile, jar"/>
	<target name="deploy" depends="clean.deploy, rebuild, javadoc, doc, init.deploy, package, runtime"/>

	<!-- ========================================================================= -->
	<!--                         Compile the application                           -->
	<!-- ========================================================================= -->

	<target name="compile" description="Compile" depends="init">
		<javac srcdir="${bootstrap.src}" destdir="${bootstrap.classes}"
			debug="on" deprecation="off" optimize="on" includes="**/*.java">
	    <classpath refid="project.classpath"/>
	    <compilerarg line="-Xlint:unchecked"/>
		</javac>
		<copy todir="${bootstrap.classes}">
			<fileset dir="${basedir}/bootstrap">
				<exclude name="**/*.java"/>
				<exclude name="**/package.html"/>
			</fileset>
		</copy>
		<javac srcdir="${src}" destdir="${classes}"
			debug="on" deprecation="off" optimize="on" includes="**/*.java">
	    <classpath refid="project.classpath"/>
	    <compilerarg line="-Xlint:unchecked"/>
		</javac>
		<copy todir="${classes}">
			<fileset dir="${src}">
				<exclude name="**/*.java"/>
				<exclude name="**/package.html"/>
			</fileset>
		</copy>
  </target>

	<!-- ========================================================================= -->
	<!--                     Build the application jar files                       -->
	<!-- ========================================================================= -->

	<target name="jar" description="generates the application jar" depends="compile">
    <jar jarfile="${build}/${app.jar.file}">
			<fileset dir="${classes}"/>
			<fileset dir="${bootstrap.classes}"/>
		</jar>
    <jar jarfile="${build}/bootstrap-${app.jar.file}">
			<fileset dir="${bootstrap.classes}"/>
		</jar>
	</target>

	<!-- ========================================================================= -->
	<!--                 Package the application for deployment                    -->
	<!-- ========================================================================= -->

	<target name="package" description="package the application into a release zip file" depends="rebuild">
		<!-- copy everything to the ${basedir}/build/deploy folder -->
		<copy tofile="${deploy}/${app.jar.file}" file="${build}/${app.jar.file}"/>
		<copy tofile="${deploy}/bootstrap-${app.jar.file}" file="${build}/bootstrap-${app.jar.file}"/>
		<copy tofile="${deploy}/${license.file}" file="${basedir}/${license.file}"/>
		<copy todir="${deploy.lib}">
			<fileset dir="${lib}"/>
		</copy>
		<copy todir="${deploy.config}">
			<fileset dir="${config}">
				<exclude name="eclipse"/>
				<exclude name="eclipse/*.*"/>
			</fileset>
		</copy>
		<copy todir="${deploy}/src">
			<fileset dir="${src}"/>
		</copy>
		<copy todir="${deploy}/bootstrap">
			<fileset dir="${bootstrap.src}"/>
		</copy>
		<copy todir="${deploy.build}/classes">
			<fileset dir="${classes}"/>
		</copy>
		<copy todir="${deploy.build}/bootstrap">
			<fileset dir="${bootstrap.classes}"/>
		</copy>
		<copy todir="${deploy}/bin">
			<fileset dir="${bin}"/>
		</copy>
		<copy todir="${deploy}/docs">
			<fileset dir="${docs}">
				<include name="api/**/*.*"/>
			</fileset>
		</copy>
		<copy todir="${deploy}/examples">
			<fileset dir="${examples}">
				<exclude name="**/*.cmd"/>
			</fileset>
		</copy>
		<copy tofile="${deploy}/README.html" file="${basedir}/index.html"/>
		<copy tofile="${deploy}/docs/home/README.html" file="${docs}/home/readme.html"/>
		<!-- Format the build number to a 4 figures integer with leading zeroes if required -->
		<!-- The build number is also incremented by 1                                      -->
		<propertyfile file="${build.number.file}">
			<entry key="build.number" type="int" default="0000" operation="+" pattern="0000" />
		</propertyfile>
		<!-- Read the build number -->
	  <property file="${build.number.file}"/>
		<tstamp>
			<format property="now" pattern="yyyyMMdd"/>
		</tstamp>
		<property name="release.file"
			value="${build}/${ant.project.name}-full-src-${version.number}.${build.number}-${now}.zip"/>
		<delete file="${release.file}" quiet="true"/>
		<zip destfile="${release.file}">
			<zipfileset dir="${deploy}" prefix="${ant.project.name}-${version.number}"/>
		</zip>
	</target>

	<!-- ========================================================================= -->
	<!--                 Package the runtime components for deployment             -->
	<!-- ========================================================================= -->

	<target name="runtime" description="" depends="rebuild">
		<antcall target="runtime.driver"/>
		<antcall target="runtime.node"/>
	</target>

	<target name="runtime.driver">
		<copy tofile="${runtime.driver}/lib/bootstrap-${app.jar.file}" file="${build}/bootstrap-${app.jar.file}"/>
		<copy tofile="${runtime.driver}/lib/${app.jar.file}" file="${build}/${app.jar.file}"/>
		<copy todir="${runtime.driver}/lib">
			<fileset dir="${lib}/log4j">
				<include name="*.*"/>
			</fileset>
		</copy>
		<copy tofile="${runtime.driver}/${license.file}" file="${basedir}/${license.file}"/>
		<copy todir="${runtime.driver}/config">
			<fileset dir="${config}/driver"/>
		</copy>
		<copy tofile="${runtime.driver}/build.xml" file="${bin}/ant-driver.xml"/>
		<property name="runtime.driver.file"
			value="${build}/${ant.project.name}-driver-bin-${version.number}.${build.number}-${now}.zip"/>
		<delete file="${runtime.driver.file}" quiet="true"/>
		<zip destfile="${runtime.driver.file}">
			<zipfileset dir="${runtime.driver}" includes="**/*.*" prefix="${ant.project.name}-${version.number}-driver"/>
		</zip>
	</target>

	<target name="runtime.node">
		<copy tofile="${runtime.node}/lib/bootstrap-${app.jar.file}" file="${build}/bootstrap-${app.jar.file}"/>
		<copy tofile="${runtime.node}/${license.file}" file="${basedir}/${license.file}"/>
		<copy todir="${runtime.node}/config">
			<fileset dir="${config}/node"/>
		</copy>
		<copy tofile="${runtime.node}/build.xml" file="${bin}/ant-node.xml"/>
		<property name="runtime.node.file"
			value="${build}/${ant.project.name}-node-bin-${version.number}.${build.number}-${now}.zip"/>
		<delete file="${runtime.node.file}" quiet="true"/>
		<zip destfile="${runtime.node.file}">
			<zipfileset dir="${runtime.node}" includes="**/*.*" prefix="${ant.project.name}-${version.number}-node"/>
		</zip>
	</target>

	<!-- ========================================================================= -->
	<!--                     Build the web site content                            -->
	<!-- ========================================================================= -->

  <target name="doc" depends="doc.home, doc.overview">
	</target>

  <target name="doc.home" description="generates the project web site pages">
		<antcall target="doc.gen">
			<param name="source" value="docs/home/doc-source"/>
			<param name="dest" value="docs/home/"/>
			<param name="templates" value="docs/home/templates/"/>
		</antcall>
	</target>

	<target name="doc.overview" description="generates the project web site pages">
		<antcall target="doc.gen">
			<param name="source" value="${home}/overview-source"/>
			<param name="dest" value="${home}/"/>
			<param name="templates" value="${home}/templates/"/>
		</antcall>
	</target>

	<target name="doc.gen" description="generates the project web site pages">
		<java fork="yes" classname="org.jppf.doc.HtmlDocGenerator" classpathref="run.classpath">
			<jvmarg value="-Xmx128m" />
			<arg value="${source}"/>
			<arg value="${dest}"/>
			<arg value="${templates}"/>
		</java>       
	</target>

	<!-- ========================================================================= -->
	<!--                        Generate the Javadoc                               -->
	<!-- ========================================================================= -->

	<target name="javadoc" description="Generate all java doc">
    <delete dir="${javadoc}" quiet="true"/>
    <mkdir dir="${javadoc}"/>
		<javadoc destdir="${javadoc}" access="private" Windowtitle="JPPF"
			packagenames="**/*.*" classpathref="javadoc.classpath" verbose="false" use="true"
			stylesheetfile="${bin}/javadoc.css" additionalparam="-quiet">
			<packageset dir="${src}"/>
			<packageset dir="${bootstrap.src}"/>
			<link href="http://java.sun.com/j2se/1.5.0/docs/api"/>
			<doctitle><![CDATA[Java Parallel Processing Framework v${version.number}]]></doctitle>
			<header>
				<![CDATA[
					<table>
					<tr>
						<td valign="center">
							<a href="http://jppf-project.sourceforge.net" target="_top">
								<img src="http://jppf-project.sourceforge.net/images/logo-small.gif" border="0" width="66" height="26"/>
							</a>
						</td>
						<td valign="center"><font face="Arial" color="#000000">&nbsp;&nbsp;Java Parallel Processing Framework</font></td>
					</tr>
					</table>
				]]>
			</header>
			<bottom>
				<![CDATA[
					<font face="Arial" size=2 color="#C0C0C0"><i>Copyright &copy; 2005-2006 Laurent Cohen.</i></font>
				]]>
			</bottom>
		</javadoc>
		<copy todir="${docs}/api/resources" overwrite="true">
			<fileset dir="${bin}">
				<include name="*.gif"/>
			</fileset>
		</copy>
	</target>

</project> 
